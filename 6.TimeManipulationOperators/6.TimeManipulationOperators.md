# 6.Time Manipulation Operators

## Shifting time

### delay

- sequence ì „ì²´ë¥¼ ë”œë ˆì´ì‹œí‚´(time-shift)
- upstream publisherê°€ ê°’ì„ ë°©ì¶œí•  ë•Œë§ˆë‹¤ delay ì˜¤í¼ë ˆì´í„°ê°€ ê°’ì„ ê°€ì§€ê³  ìˆë‹¤ê°€ delayì‹œê°„ ì´í›„ì— ê°’ì„ ë°©ì¶œí•œë‹¤.
- ìŠ¤ì¼€ì¥´ì„ ì§€ì •í•  ìˆ˜ ìˆìŒ. ì§€ì •ëœ ìŠ¤ì¼€ì¥´ëŸ¬ì—ì„œ ê°’ì„ ë°©ì¶œí•¨. (ìŠ¤ì¼€ì¥´ëŸ¬ëŠ” ë‚˜ì¤‘ì— ë°°ìš¸ ê²ƒì„)

(ê·€ì°®ì€ê±´ì§€â€¦ í‘œí˜„í•˜ê¸° ì–´ë ¤ìš´ê±´ì§€ ëª¨ë¥´ê² ì§€ë§Œ ë‹¤ì´ì–´ê·¸ë¨ì´ ì•„ë‹ˆë¼ Live Viewë¡œ ë³´ì—¬ì£¼ê¸° ì‹œì‘í•œë‹¤ ã…ã…)

![Untitled](6%20Time%20Manipulation%20Operators%20cb2e451723384432b0c83f29ddae1a78/Untitled.png)

ê³µì‹ë¬¸ì„œ ì˜ˆì œê°€ ì¡°ê¸ˆ ë” ì˜ í‘œí˜„í•œê±° ê°™ë‹¤. ([https://developer.apple.com/documentation/combine/just/delay(for:tolerance:scheduler:options:)](https://developer.apple.com/documentation/combine/just/delay(for:tolerance:scheduler:options:))

- Timerë‚˜ autoconnectëŠ” ë‚˜ì¤‘ì— ë°°ìš¸í…Œë‹ˆ ì§€ê¸ˆì€ ê°€ë³ê²Œ ì´í•´ë§Œí•˜ê³  ë„˜ì–´ê°€ì.
    - TimerëŠ” ì§€ì •ëœ RunLoopì—ì„œ ì¼ì •í•œ ê°„ê²©ìœ¼ë¡œ ê°’ì„ ë°©ì¶œí•´ì¤€ë‹¤.
    - autoconnect() : ì²«ë²ˆì§¸ subscriptionì´ ì—°ê²°ë˜ë©´ ì¦‰ì‹œ ê°’ì„ ë°©ì¶œí•˜ê¸° ì‹œì‘.
- **ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ê²ƒì€ delayë¥¼ ì´í•´í•˜ëŠ” ê²ƒ.** â­
    - receiveValueìª½ì„ ë³´ë©´ nowì™€ value 3ì´ˆ ì°¨ì´ë‚˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
    - ì´ë¥¼ í†µí•´ delayê°€ ì—…ìŠ¤íŠ¸ë¦¼ì„ í†µí•´ ***ë°›ì€ ê°’ì„ ê°€ì§€ê³  ìˆë‹¤ê°€***  ë”œë ˆì´ ì‹œê°„ ì´í›„ ê°’ì„ ì§€ì—°ì‹œì¼œì„œ ë°©ì¶œí•œë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. â†’ ê·¸ë ‡ê¸° ë•Œë¬¸ì— 3ì´ˆë’¤ì— ê°’ì„ ë°›ì•„ë„ 3ì´ˆì „ì˜ ê°’ì´ valueë¡œ ìŠ¤íŠ¸ë¦¼ì— íë¥´ê²Œ ëœë‹¤.

```swift
let df = DateFormatter()
df.dateStyle = .none
df.timeStyle = .long

let cancellable = Timer.publish(every: 1.0, on: .main, in: .default)
  .autoconnect()
  .handleEvents(receiveOutput: { date in
      print ("Sending Timestamp \'\(df.string(from: date))\' to delay()")
  })
  .delay(for: .seconds(3), scheduler: RunLoop.main, options: .none)
  .sink(
      receiveCompletion: { print ("completion: \($0)", terminator: "\n") },
      receiveValue: { value in
          let now = Date()
          print ("At \(df.string(from: now)) received  Timestamp \'\(df.string(from: value))\' sent: \(String(format: "%.2f", now.timeIntervalSince(value))) secs ago", terminator: "\n")
      }
  )

// Prints:
//    Sending Timestamp '5:02:33 PM PDT' to delay()
//    Sending Timestamp '5:02:34 PM PDT' to delay()
//    Sending Timestamp '5:02:35 PM PDT' to delay()
//    Sending Timestamp '5:02:36 PM PDT' to delay()
//    At 5:02:36 PM PDT received  Timestamp '5:02:33 PM PDT' sent: 3.00 secs ago
//    Sending Timestamp '5:02:37 PM PDT' to delay()
//    At 5:02:37 PM PDT received  Timestamp '5:02:34 PM PDT' sent: 3.00 secs ago
//    Sending Timestamp '5:02:38 PM PDT' to delay()
//    At 5:02:38 PM PDT received  Timestamp '5:02:35 PM PDT' sent: 3.00 secs ago
```

## Collecting values

ì§€ì •ëœ ì‹œê°„ ê°„ê²©ìœ¼ë¡œ valueë¥¼ collectí•˜ê³  ì‹¶ì„ ë•Œ

ex. ì§§ì€ ì‹œê°„ ë™ì•ˆ ë°©ì¶œëœ ê°’ì˜ í‰ê· ì„ êµ¬í•´ì„œ ì¶œë ¥í•˜ê³  í”Œ ë•Œ.

### collect(.byTime(Context, Stride)

- ì´ì „ì— ë´¤ë˜ collectì˜ ë‹¤ë¥¸ ë²„ì „. TimeGroupingStrategyë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ëŠ”ë‹¤.
- `Publishers.TimeGroupingStrategy<S>, options: S.SchedulerOptions? = **nil**`
    
    ![Untitled](6%20Time%20Manipulation%20Operators%20cb2e451723384432b0c83f29ddae1a78/Untitled%201.png)
    
- ì˜ˆì œëŠ” ê·¸ëƒ¥ ê°„ë‹¨í•œê±¸ë¡œ ì§ì ‘ ë§Œë“¤ì—ˆë‹¤.
- Timerì—ì„œ 1ì´ˆë§ˆë‹¤ ê°’ì´ ë°©ì¶œë˜ê³  4ì´ˆë™ì•ˆ ê°’ì„ collect í•œ í›„ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ì— í˜ë ¤ì¤€ë‹¤.
    - handleEventsë¥¼ í†µí•´ 1ì´ˆë§ˆë‹¤ì˜ ê°’ í™•ì¸.
    - sinkì—ì„œ ê°’ì„ ì¶œë ¥ â†’ 4ì´ˆ ë™ì•ˆ ëª¨ì€ ê°’ë“¤ì˜ ë°°ì—´

```swift
let sourcePublisher = PassthroughSubject<Date, Never>()

let cancellable = Timer.publish(every: 1, on: .main, in: .common)
  .autoconnect()
  .handleEvents(receiveOutput: { print("handle events: \($0)") })
  .collect(.byTime(DispatchQueue.main, .seconds(4)))
  .sink(receiveCompletion: { print($0) }, receiveValue: { print($0)})
/*
handle events: 09:00:02 +0000
handle events: 09:00:03 +0000
handle events: 09:00:04 +0000
handle events: 09:00:05 +0000
[09:00:02 +0000,
 09:00:03 +0000,
 09:00:04 +0000,
 09:00:05 +0000]
*/
```

### collect(.byTimeOrCount(ìŠ¤ì¼€ì¥´ëŸ¬, ì‹œê°„, ë²„í¼ë§¥ì‹œë©ˆ ì‚¬ì´ì¦ˆ))

- (ìœ„ì˜ ì‹œê°„ìœ¼ë¡œë§Œ collectí•˜ëŠ”ê²ƒë³´ë‹¤ ì¡°ê¸ˆ ë” ìƒê°ì„ í•´ì•¼í•œë‹¤.)
- Timeì´ë‚˜ Count ê¸°ì¤€ìœ¼ë¡œ collect ëœ ê°’ì„ ë°©ì¶œí•œë‹¤.
- ì½”ë“œë¥¼ ì ì–´ë³´ê³  ì´í•´í•´ë³´ì. ìŠ¤ì¼€ì¥´ëŸ¬ íŒŒë¼ë¯¸í„°ëŠ” ìƒëµí•˜ê² ë‹¤.
    - íƒ€ì´ë¨¸ì—ì„œ 1ì´ˆë§ˆë‹¤ ê°’ì„ í˜ë ¤ì£¼ê³  ìˆë‹¤ê³  ê°€ì •

```swift
Timer.publish(every: 1, on: .main, in: .common)

// A. 4ì´ˆ Or 2ê°œ
// 4ì´ˆê°€ ë˜ê¸° ì „ì— 2ì´ˆë§ˆë‹¤ 2ê°œ ë„ë‹¬
collect(.byTimeOrCount(.seconds(4), 2))
// B. 4ì´ˆ Or 3ê°œ
// 3ê°œê°€ ë„ë‹¬ëœ í›„ 4ì´ˆê°€ ë˜ì–´ì„œ ëª¨ì•˜ë˜ 1ê°œ ë§ˆì € ë‚´ë¦¬ê¸°
collect(.byTimeOrCount(.seconds(4), 3))
// B. 5ì´ˆ Or 2ê°œ
// 2ì´ˆë§ˆë‹¤ 2ê°œ ë„ë‹¬, 5ì´ˆë§ˆë‹¤ ëª¨ì•˜ë˜ 1ê°œ
collect(.byTimeOrCount(.seconds(4), 1))
```

![Untitled](6%20Time%20Manipulation%20Operators%20cb2e451723384432b0c83f29ddae1a78/Untitled%202.png)

## Holding off on events

### debounce â­

- ì§€ì •ëœ ì¸í„°ë²Œë™ì•ˆ ì´ë²¤íŠ¸ë¥¼ ë°›ê³ , ì¸í„°ë²Œì´ ëë‚˜ë©´ ë§ˆì§€ë§‰ ê°’ì„ ë‚´ë ¤ì¤€ë‹¤. ì¸í„°ë²Œë‚´ì— ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ë‹¤ì‹œ ì¸í„°ë²Œ ì´ˆê¸°í™”. (throttleê³¼ ì˜ êµ¬ë¶„í•´ì„œ ì“°ì)
- search ê¸°ëŠ¥ì— í™œìš©í•˜ëŠ”ê±° ë§ì´ë´¤ìŒ.
- debounceì˜ ì‹œê°„ì´ ê²½ê³¼í•˜ê¸° ì „ì— ìŠ¤íŠ¸ë¦¼ì´ ì™„ë£Œë˜ë©´, debounce ì‹œê°„ì´ ì§€ë‚˜ë”ë¼ë„ ê°’ì„ ë°›ì„ ìˆ˜ ì—†ë‹¤. (completeì´ ë¨¼ì €ë˜ëŠ” ê²½ìš°)
    - í”íˆ í•˜ëŠ” APIë¥¼ í˜¸ì¶œì˜ ê²°ê³¼ë¥¼ Futureë¡œ ë°›ëŠ”ë° .debounce(ì‹œê°„)ì„ ê±¸ì—ˆëŠ”ë° ì‹œê°„ë³´ë‹¤ APIê°€ ë¹¨ë¦¬ ë„ì°©í•˜ë©´, completeì´ ë‚¬ê¸° ë•Œë¬¸ì— ì‚¬ì‹¤ìƒ ê°’ì„ ë°›ì§€ ëª»í•˜ê³  completionë§Œ ë°›ìŒ.
- ì´ê±´ ì‚¬ì‹¤ rxë‹¤ì´ì–´ê·¸ë¨ì´ í›¨ì”¬ ì˜í‘œí˜„í•´ë†“ì•˜ë‹¤.

![Untitled](6%20Time%20Manipulation%20Operators%20cb2e451723384432b0c83f29ddae1a78/Untitled%203.png)

### throttle

- ìµœì´ˆ ì´ë²¤íŠ¸ ë°œìƒ ì´í›„ë¡œ ì¸í„°ë²Œë™ì•ˆ ê°’ì„ ë‚´ë ¤ë³´ë‚´ì§€ ì•ŠëŠ”ë‹¤. ì´í›„ latestì— ë”°ë¼ ì¸í„°ë²Œë™ì•ˆ ë°œìƒí•œ ë§ˆì§€ë§‰, ì²« ê°’ ì¤‘ ì„ íƒí•´ì„œ ë‚´ë ¤ë³´ëƒ„.
- debounceì™€ ë‹¤ë¥´ê²Œ ì´ë²¤íŠ¸ê°€ ì¸í„°ë²Œë™ì•ˆ ì´ë²¤íŠ¸ ë°œìƒí•˜ëŠ” ê²ƒì´ ì¸í„°ë²Œì„ ë¦¬ì…‹ì‹œí‚¤ì§€ ì•ŠìŒ.
- latest íŒŒë¼ë¯¸í„°: ìŠ¤ë¡œí‹€ ê°€ì¥ ìµœê·¼ì˜ ê°’ì„ ì“¸ì§€,
    - ë²„íŠ¼ í´ë¦­ - ğŸ, sinkvalue - ğŸŒ, throttle time : 3ì´ˆ

```swift
ë²„íŠ¼í´ë¦­.publisher
.throttle(for: 3.0, scheduler: RunLoop.main, latest: true)

// latest = true
/*
MasonğŸğŸğŸ: 1
MasonğŸŒğŸŒ: 1 // ìµœì´ˆì˜ ê°’ì„ ë¨¼ì € ë°›ëŠ” ê²ƒì„ ì¸ì§€í•˜ì.
MasonğŸğŸğŸ: 2
MasonğŸğŸğŸ: 3
MasonğŸğŸğŸ: 4
MasonğŸŒğŸŒ: 4 // 3ì´ˆ ë’¤
*/

// latest = false
/*
MasonğŸğŸğŸ: 1
MasonğŸŒğŸŒ: 1 // ìµœì´ˆì˜ ê°’ì„ ë¨¼ì € ë°›ëŠ” ê²ƒì„ ì¸ì§€í•˜ì.
MasonğŸğŸğŸ: 2
MasonğŸğŸğŸ: 3
MasonğŸğŸğŸ: 4
MasonğŸğŸğŸ: 5
MasonğŸŒğŸŒ: 2 // 3ì´ˆ ë’¤
*/
```

## Timing out

**timeout**

- êµ¬ë…ì‹œì‘ê³¼ í•¨ê»˜ timeoutì„ ê±´ë‹¤.
- customError íŒŒë¼ë¯¸í„°ë¥¼ ë„˜ê¸°ë©´ ì—ëŸ¬ë¡œ completeì´ ë‚˜ê³ , ë„˜ê¸°ì§€ ì•Šìœ¼ë©´(default = nil) finishedë¡œ completeì´ ë‚œë‹¤.

```swift
enum TimeoutError: Error {
  case timedOut
}

publisher
.timeout(.seconds(5),
	 scheduler: DispatchQueue.main,
	 customError: { TimeoutError.timedOut }
)
// completion with failure

publisher
.timeout(.seconds(5),
 scheduler: DispatchQueue.main
)
// completion with finished
```

## Measuring time

- upstreamìœ¼ë¡œë¶€í„° ë‚˜ì˜¤ëŠ” ì´ë²¤íŠ¸ ì‚¬ì´ì˜ ì‹œê°„ì„ ì¸¡ì •í•´ì¤€ë‹¤.
- ì–¸ì œ ì“°ëŠ” ë¬¼ê±´ì¸ê³ â€¦

```swift
Timer.publish(every: 3, on: .main, in: .default)
    .autoconnect()
    .handleEvents(receiveOutput: { print("value: \($0)") })
    .measureInterval(using: RunLoop.main)
    .sink(receiveValue: {print($0)})
    .store(in: &cancellables)

/*
Stride(magnitude: 2.0010629892349243)
Stride(magnitude: 1.9999699592590332)
Stride(magnitude: 1.9999080896377563)
Stride(magnitude: 1.9999839067459106)
Stride(magnitude: 1.999988079071045)
*/
```